<html>
<head>
  <title>基于POS配置主从集群</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/606060 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="921"/>
<h1>基于POS配置主从集群</h1>

<div>
<span><div>主节点配置</div><div><br/></div><div>查看binlog是否开启可以使用命令</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>show variables like 'log_bin%';</div></div><div><img src="基于POS配置主从集群_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>log_bin为OFF代表是未开启状态</div><div><br/></div><div><br/></div><div> 修改my.cnf文件(默认/etc/my.cnf)</div><div>在[mysqld]段下面添加</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># binlog刷盘策略</div><div>sync_binlog=1</div><div># 需要备份的数据库</div><div>binlog-do-db=hello</div><div># 不需要备份的数据库</div><div>binlog-ignore-db=mysql</div><div># 启动二进制文件</div><div>log-bin=mysql-bin</div><div># 服务器ID</div><div>server-id=132</div><div>#只保留7天的二进制日志，以防磁盘被日志占满(可选)</div><div>expire-logs-days=7</div></div><div><br/></div><div>重启mysql服务</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>systemctl restart mysqld</div></div><div><br/></div><div>查看master状态</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql&gt; show master status;</div><div>+------------------+----------+--------------+------------------+------------</div><div>-------+</div><div>| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div>Executed_Gtid_Set |</div><div>+------------------+----------+--------------+------------------+------------</div><div>-------+</div><div>| mysql-bin.000002 | 593 | hello | mysql |</div><div>|</div><div>+------------------+----------+--------------+------------------+------------</div><div>-------+</div><div>1 row in set</div></div><div><br/></div><div>主机给从机授权备份权限</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>GRANT REPLICATION SLAVE ON *.* TO '从机MySQL用户名'@'从机IP' identified</div><div>by '从机MySQL密码';</div><div><br/></div><div># 示例</div><div>GRANT REPLICATION SLAVE ON *.* TO 'root'@'%' identified by 'admin';</div></div><div><br/></div><div>注意：一般不用root账号，%表示所有客户端都可以连接，一般都是由ip代替</div><div><br/></div><div><br/></div><div>从服务器配置</div><div>修改my.cnf文件(默认/etc/my.cnf)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[mysqld]</div><div>server-id=133</div><div><br/></div><div>#如果salve库名称与master库名相同，使用本配置</div><div>replicate-do-db = hello</div><div>#如果master库名[hello]与salve库名[hello01]不同，使用以下配置[需要做映射]</div><div>replicate-rewrite-db = hello -&gt; hello01</div><div>#如果不是要全部同步[默认全部同步]，则指定需要同步的表</div><div>replicate-wild-do-table=hello01.t1</div><div>replicate-wild-do-table=hello01.tab_user</div></div><div><br/></div><div>重启mysqld服务</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>systemctl restart mysqld</div></div><div><br/></div><div>配置slave</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql&gt;change master to</div><div>master_host='123.57.135.5',</div><div>master_port=3306,</div><div>master_user='root',</div><div>master_password='root',</div><div>master_log_file='mysql-bin.000002',</div><div>master_log_pos=593,</div><div>MASTER_AUTO_POSITION=0;</div><div><br/></div><div>#master_port 为MySQL服务器端口号（无引号） </div><div>#master_user 为执行同步操作的数据库账户</div><div># 593 无单引号（此处的593 就是show master status 中看到的position 的值</div><div># mysql-bin.000002 就是show master status的file 对应的值</div></div><div><br/></div><div>启动从服务器复制功能</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql&gt;start slave;</div></div><div><br/></div><div>检查从服务器复制功能状态</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql&gt; show slave status \G;</div><div>……………………(省略部分)</div><div>Slave_IO_Running: Yes //此状态必须YES</div><div>Slave_SQL_Running: Yes //此状态必须YES</div><div>……………………(省略部分)</div></div><div><br/></div><div>Slave_IO_Running为no时，有可能是/etc/my.cnf的server-id一样，或者有可能是/var/lib/mysql/auto.cnf的server-uuid一样的原因导致</div><div><br/></div><div><br/></div><div>/var/lib/mysql/auto.cnf存放是GTID的值</div><div>从MySQL 5.6.5 开始新增了一种基于 GTID 的复制方式。GTID即全局事务ID （Global Transaction</div><div>Identifier），其保证为每一个在主上提交的事务在复制集群中可以生成一个唯一的ID。</div><div>这种方式强化了数据库的主备一致性，故障恢复以及容错能力。GTID在一主一从情况下没有优势，对于</div><div>两主以上的结构优势异常明显，可以在数据不丢失的情况下切换新主。</div><div>GTID实际上是由UUID+TID (即transactionId)组成的，其中UUID(即server_uuid) 产生于auto.conf文</div><div>件，是一个MySQL实例的唯一标识。TID代表了该实例上已经提交的事务数量，并且随着事务提交单调</div><div>递增，所以GTID能够保证每个MySQL实例事务的执行。GTID在一组复制中，全局唯一。 通过GTID的</div><div>UUID可以知道这个事务在哪个实例上提交的。</div><div><br/></div><div><br/></div></span>
</div></body></html> 